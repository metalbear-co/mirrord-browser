name: Release

on:
    push:
        tags: ['v*']

permissions:
    contents: write

jobs:
    build-and-publish:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '24'

            - name: Install pnpm
              run: npm install -g pnpm

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Validate version matches tag
              run: |
                  TAG_VERSION="${GITHUB_REF_NAME#v}"
                  PKG_VERSION=$(node -p "require('./package.json').version")
                  MANIFEST_VERSION=$(node -p "require('./src/manifest.json').version")
                  echo "Tag version: $TAG_VERSION"
                  echo "package.json version: $PKG_VERSION"
                  echo "manifest.json version: $MANIFEST_VERSION"
                  if [ "$PKG_VERSION" != "$TAG_VERSION" ]; then
                    echo "::error::package.json version ($PKG_VERSION) does not match tag ($TAG_VERSION)"
                    exit 1
                  fi
                  # manifest.json may use shorter format (e.g. "0.3" vs "0.3.0")
                  # Strip trailing ".0" segments from tag for comparison
                  TAG_SHORT=$(echo "$TAG_VERSION" | sed 's/\.0$//')
                  if [ "$MANIFEST_VERSION" != "$TAG_VERSION" ] && [ "$MANIFEST_VERSION" != "$TAG_SHORT" ]; then
                    echo "::error::manifest.json version ($MANIFEST_VERSION) does not match tag ($TAG_VERSION or $TAG_SHORT)"
                    exit 1
                  fi

            - name: Run tests
              run: pnpm test

            - name: Build extension
              run: pnpm build

            - name: Zip extension
              run: cd dist && zip -r ../extension.zip .

            - name: Upload to Chrome Web Store
              run: |
                  ACCESS_TOKEN=$(curl -sf -X POST https://oauth2.googleapis.com/token \
                    -d "client_id=${{ secrets.CWS_CLIENT_ID }}" \
                    -d "client_secret=${{ secrets.CWS_CLIENT_SECRET }}" \
                    -d "refresh_token=${{ secrets.CWS_REFRESH_TOKEN }}" \
                    -d "grant_type=refresh_token" | jq -r '.access_token')

                  echo "Uploading extension..."
                  UPLOAD_RESPONSE=$(curl -s -X PUT \
                    "https://www.googleapis.com/upload/chromewebstore/v1.1/items/${{ secrets.CWS_EXTENSION_ID }}" \
                    -H "Authorization: Bearer $ACCESS_TOKEN" \
                    -H "x-goog-api-version: 2" \
                    -T extension.zip)
                  echo "$UPLOAD_RESPONSE"

                  UPLOAD_STATUS=$(echo "$UPLOAD_RESPONSE" | jq -r '.uploadState')
                  if [ "$UPLOAD_STATUS" != "SUCCESS" ]; then
                    echo "::error::Upload failed with status: $UPLOAD_STATUS"
                    exit 1
                  fi

                  echo "Publishing extension..."
                  PUBLISH_RESPONSE=$(curl -s -X POST \
                    "https://www.googleapis.com/chromewebstore/v1.1/items/${{ secrets.CWS_EXTENSION_ID }}/publish" \
                    -H "Authorization: Bearer $ACCESS_TOKEN" \
                    -H "x-goog-api-version: 2")
                  echo "$PUBLISH_RESPONSE"

            - name: Create GitHub Release
              env:
                  GH_TOKEN: ${{ github.token }}
              run: gh release create "$GITHUB_REF_NAME" extension.zip --generate-notes
